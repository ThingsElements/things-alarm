<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-badge/paper-badge.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/maps-icons.html">
<link rel="import" href="../iron-icons/notification-icons.html">
<link rel="import" href="../iron-icons/places-icons.html">
<link rel="import" href="../iron-signals/iron-signals.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../things-msg-box-behavior/things-msg-box-behavior.html">
<link rel="import" href="../things-input-field/things-input-field.html">
<link rel="import" href="../things-input-field/things-textarea.html">

<!--
things-alarm-badge. count 횟수를 badge 형태로 출력하고 toggleAlarm()을 통해 count를 초기화 하는 컴퍼넌트

  Example:
    
    <things-alarm-badge
      count="10">
    </things-alarm-badge>

@demo demo/index.html
-->
<dom-module id="things-alarm-badge">
  <style>
    .dropdown-content {
      background-color: white;
    }
    label{
      @apply(--things-label);
    }
    iron-dropdown{
      margin:30px 0 0 9%;
      border:2px solid rgba(0,0,0,.2);
      text-align:center;
    }
    iron-dropdown:before{
      @apply(--things-dropdown-arrow);
    }
    paper-item{
      @apply(--things-dropdown-item);
    }
    paper-item span{
      opacity:.6;
      font-size:12px;
    }
    paper-dialog {
        position: fixed;
        top: 10%;
        bottom: 10%;
        left: 15%;
        right: 15%;
        margin: 0px;
        @apply(--layout-flex);
        @apply(--layout-vertical);
    }

    paper-dialog::shadow .toolbar-tools.paper-toolbar {
        padding: 0
    }

    paper-dialog::shadow span.title.things-image-selector {
        margin-left: 15px !important
    }

    paper-toolbar {
        background-color: var(--things-primary-background-color);
        height: 45px;
        margin-top: 0px !important;
        @apply(--things-padding-clear)
    }

    paper-toolbar::shadow #topBar {
        height: 45px;
    }

    paper-toolbar .title {
        margin-left: 32px !important;
        line-height: initial !important;
    }
    .close-btn {
        @apply(--things-header-button);
        background: url(/images/icon-close.png) 100% 50% no-repeat;
        margin-right: 10px;
    }     
  </style>
  <template>
    <iron-signals id="signals"></iron-signals>
    <iron-localstorage id="alarm-storage" name="alarmMessages" value="{{messages}}"></iron-localstorage>

    <paper-icon-button id="alarm-button" icon="icons:mail" alt="alarm" on-tap="toggleAlarm"></paper-icon-button>
    <paper-badge for="number" label="[[count]]" hidden="[[isNoMsg]]"></paper-badge>

    <iron-dropdown id="dropdown-list" horizontal-align="left" vertical-align="top">
      <div class="dropdown-content">
        <template is="dom-repeat" items="[[messages]]">
          <paper-item on-tap="onMessageTap">[[item.created_at]]&nbsp;<span>[[item.title]]&nbsp;<span>[[item.message]]</span></paper-item>
        </template>
      </div>
    </iron-dropdown>
    
    <paper-dialog id="msg-dialog">
        <paper-toolbar>
            <span class="title">Alarm Message</span>
            <div class="buttonsGroup">
                <button dialog-dismiss class="close-btn"></button>
            </div>
        </paper-toolbar>

        <div>
          <div class="layout horizontal">
            <things-input-field class="flex" label="Title" value="[[title]]" readonly></things-input-field>
            <things-input-field class="flex" label="Created At" value="[[createdAt]]" readonly></things-input-field>
          </div>
          <div>
            <things-textarea class="flex" label="Content" value="[[content]]" readonly></things-textarea>
          </div>
        </div>
    </paper-dialog>

  </template>

  <script type="text/javascript">
    (function() {
      Polymer({
        is: "things-alarm-badge",

        behaviors: [
          Things.MsgBoxBehavior
        ],

        listeners: {
          "alarm-storage.iron-localstorage-load-empty": "storageEmpty",
          "signals.iron-signal-subscribed": '_alarmArrived'
        },

        properties: {

          /**
           * local storage에 저장된 message list
           */
          messages: {
            type: Array,
            observer: '_messagesChanged'
          },

          /**
           * badge에 표시할 현재 message의 count
           */
          count: {
            type: Number,
            value: 0
          },

          /**
           * count가 0이면 isNoMsg가 true가 되어 badge를 hidden 처리한다.
           */
          isNoMsg: {
            type: Boolean,
            value: true
          },

          /**
           * subscribe한 message의 제목
           */
          title: {
            type: String
          },

          /**
           * subscribe한 message의 내용
           */
          content: {
            type: String
          },

          /**
           * message 생성 시간
           */
          createdAt : {
            type: String
          }
        },

        /**
         * iron-signal을 통한 subscribe event listener
         */
        _alarmArrived: function(event) {
          var message = event.detail;
          this.addMessage(message);

          switch (message.type) {
            case 'popup':
              this.openConfirmMsg({
                type: 'warning',
                title: message.title,
                text: message.message
              })

              break;

            case 'badge':
              break;

            default:
              break;
          }
        },

        /**
         * 새로 전달 받은 message를 messages에 추가하고
         * count의 값을 계산하는 function 호출
         */
        addMessage: function(message) {
          this.unshift('messages', message);
          this.calcCount();
        },

        /**
         * 메시지가 변경 되었을 때 count를 다시 계산한다.
         */
        _messagesChanged: function() {
          this.calcCount();          
        },

        /**
         * count를 계산하고 만약 0이면 badge를 숨긴다.
         */
        calcCount: function() {
          if(this.messages) {
            this.count = this.messages.length;
          }
          this.isNoMsg = (this.count == 0) ? true : false;
        },

        /**
         * badge 클릭시 드롭다운 리스트를 토글
         */
        toggleAlarm: function () {
          if(this.count == 0) return;
          this.$['dropdown-list'].toggle();
        },

        /**
         * local storage가 정의 되어 있지 않을때 빈값으로 초기화 한다.
         */
        storageEmpty: function() {
          this.messages = [];
        },

        /**
         * toggle된 dropdown list에서 메시지를 클릭하면
         * 해당 메시지의 상세 내역을 다이얼로그로 보여주고 
         * 확인한 removeMsg function을 호출
         */
        onMessageTap: function(event) {
          var idx = event.model.index;
          var item = event.model.item;
          
          this.title = item.title;
          this.createdAt = item.created_at;
          this.msgType = item.type;
          this.content = item.message;
          
          this.toggleAlarm();
          this.$['msg-dialog'].open();
          this.removeMsg(idx);
        },

        /**
         * local storage의 index를 통해 확인한 메시지를 제거
         */
        removeMsg: function(idx) {
          this.splice('messages', idx, 1);
          this.calcCount();
        }
      })
    })();
  </script>
</dom-module>
